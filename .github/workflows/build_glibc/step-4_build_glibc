#!/bin/bash
set -euox pipefail
source ${SCRIPTS_DIR}/environment

export PATH=${SYSROOT_DIR}/bin:${PATH}

GLIBC_BUILD_DIR="/tmp/glibc-build"
mkdir -p "${GLIBC_BUILD_DIR}"

pushd "${GLIBC_BUILD_DIR}"

# -fcf-protection controls CET (Control-flow Enforcement Technology), an x86-specific feature.
# On aarch64, GCC doesn't recognize this flag.
ARCH_CC_FLAGS=""
ARCH_CFLAGS=""
CONFIGURE_FLAGS=()
if [[ "${BUILD_ARCH}" == "x86_64" ]]; then
    ARCH_CC_FLAGS="-fcf-protection=none"
    ARCH_CFLAGS="-fcf-protection=none"
    CONFIGURE_FLAGS+=(--disable-cet)
fi

# ===============
# || Configure ||
# ===============
env BUILD_CC=gcc \
    CC="${BUILD_ARCH}-bootstrap-linux-gnu-gcc -O3 -fcommon -U_FORTIFY_SOURCE -Wno-missing-attributes -Wno-array-bounds -Wno-array-parameter -Wno-stringop-overflow -Wno-maybe-uninitialized -Wno-implicit-int ${ARCH_CC_FLAGS}" \
    CFLAGS="${ARCH_CFLAGS}" \
    AR=${BUILD_ARCH}-bootstrap-linux-gnu-ar \
    RANLIB=${BUILD_ARCH}-bootstrap-linux-gnu-ranlib \
    ${GLIBC_SOURCE}/configure \
        --prefix=/usr \
        --host=${BUILD_ARCH}-linux-gnu \
        --without-cvs \
        --disable-profile \
        --without-gd \
        --with-headers=${SYSROOT_DIR}/usr/include \
        --disable-debug \
        ${CONFIGURE_FLAGS[@]:+"${CONFIGURE_FLAGS[@]}"} \
        --disable-sanity-checks \
        --enable-obsolete-rpc \
        --enable-kernel="" \
        --with-__thread \
        --with-tls \
        --enable-shared \
        --enable-add-ons=no \
        --disable-werror

# ===========
# || Build ||
# ===========
make -j$(nproc) -l \
    CXX="" \
    LDFLAGS="" \
    default_cflags="" \
    BUILD_CFLAGS="-O2 -g" \
    BUILD_CPPFLAGS="" \
    BUILD_LDFLAGS="" \
    all

# =============
# || Install ||
# =============
make -j$(nproc) -l \
    CXX="" \
    default_cflags="" \
    BUILD_CFLAGS="-O2 -g" \
    BUILD_CPPFLAGS="" \
    BUILD_LDFLAGS="" \
    install_root="${GLIBC_ARTIFACTS}" \
    install

popd

# Disable CET (Control-flow Enforcement Technology) to avoid linker errors
# with older glibc versions that don't fully support it.
# See build_gcc_standalone/step-14_build_glibc for details on the specific error.

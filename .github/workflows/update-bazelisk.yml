name: Update Bazelisk

on:
  schedule:
    # Run nightly at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:  # Allow manual triggering

permissions:
  contents: write
  pull-requests: write

jobs:
  update-bazelisk:
    runs-on: ubuntu-latest
    name: Check for Bazelisk updates

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Update Bazelisk binaries
        id: update
        run: |
          ./bazel --update-bazelisk

      - name: Check for changes
        id: check_changes
        run: |
          if git diff --quiet tools/bazelisk-*; then
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "No changes detected"
          else
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "Changes detected"
          fi

      - name: Create branch and commit changes
        if: steps.check_changes.outputs.changed == 'true'
        id: commit
        run: |
          # Get the new version from the updated binary
          NEW_VERSION=$(./tools/bazelisk-linux-amd64 version | head -n1 | sed 's/Bazelisk version: //')

          # Configure git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Create a new branch
          BRANCH_NAME="update-bazelisk-${NEW_VERSION}"
          git checkout -b "$BRANCH_NAME"

          # Add and commit changes
          git add tools/bazelisk-*

          git commit -m "$(cat <<EOF
          chore: update Bazelisk to ${NEW_VERSION}

          Problem
          ================================================================================

          Bazelisk binaries need to be kept up-to-date to ensure compatibility with the
          latest Bazel releases and to receive security updates and bug fixes.

          Context
          ================================================================================

          What was the previous state?
          --------------------------------------------------------------------------------

          The repository was using an older version of Bazelisk. A new release
          (${NEW_VERSION}) is now available with potential improvements and fixes.

          Solution
          ================================================================================

          Update all Bazelisk binaries (linux-amd64, linux-arm64, darwin-amd64,
          darwin-arm64, windows-amd64, windows-arm64) to ${NEW_VERSION} by running the
          automated update script.

          Rationale
          ================================================================================

          Why automate this update?
          --------------------------------------------------------------------------------

          Bazelisk updates are straightforward and low-risk. Automating the update
          process ensures timely adoption of new releases without manual intervention.

          Why update all platforms at once?
          --------------------------------------------------------------------------------

          Keeping all platform binaries at the same version ensures consistent behavior
          across development environments and simplifies version tracking.
          EOF
          )"

          # Push the branch
          git push origin "$BRANCH_NAME"

          # Save version and branch for PR creation
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT

      - name: Create Pull Request
        if: steps.check_changes.outputs.changed == 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          NEW_VERSION="${{ steps.commit.outputs.new_version }}"

          gh pr create \
            --title "chore: update Bazelisk to ${NEW_VERSION}" \
            --body "$(cat <<EOF
          ## Summary

          - Updates Bazelisk binaries to ${NEW_VERSION}
          - Automated update triggered by nightly workflow

          ## Test Plan

          - [ ] Verify bazel wrapper still works: \\\`./bazel version\\\`
          - [ ] Run basic build: \\\`./bazel build //...\\\`
          - [ ] Run tests: \\\`./bazel test //...\\\`

          ðŸ¤– Automated update generated by [update-bazelisk.yml](.github/workflows/update-bazelisk.yml)
          EOF
          )" \
            --base main \
            --head "${{ steps.commit.outputs.branch_name }}"

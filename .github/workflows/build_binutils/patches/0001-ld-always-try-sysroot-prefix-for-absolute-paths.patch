From 471d1d6d49821cfadfc232d2e44eaaa76f6e4186 Mon Sep 17 00:00:00 2001
From: Sven Rebhan <odinshorse@googlemail.com>
Date: Mon, 8 Aug 2022 20:46:29 +1200
Subject: [PATCH] ld: always try sysroot prefix for absolute paths

Always try to prepend the sysroot prefix to absolute filenames first.

When ld opens a linker script (e.g. libm.so containing GROUP directives
with absolute paths like /lib64/libm.so.6), it uses is_sysrooted_pathname()
to decide whether those absolute paths should be resolved relative to the
sysroot. is_sysrooted_pathname() canonicalizes both paths via lrealpath()
(which calls realpath()) and checks if the script path starts with the
sysroot path. This fails when symlinks cause the two paths to resolve to
different base directories, as happens in Bazel's sandbox where directories
are real but leaf files are symlinks to the external repo cache.

This patch changes ldfile_open_file_search() to always try prepending
the sysroot to absolute paths, regardless of is_sysrooted_pathname().
If the sysroot-prepended path exists, it's used. Otherwise, the original
absolute path is tried as a fallback.

http://bugs.gentoo.org/275666
http://sourceware.org/bugzilla/show_bug.cgi?id=10340

Signed-off-by: Sven Rebhan <odinshorse@googlemail.com>
---
 ld/ldfile.c | 11 +++++++++--
 1 file changed, 9 insertions(+), 2 deletions(-)

diff --git a/ld/ldfile.c b/ld/ldfile.c
index 75fd360d..6d208be3 100644
--- a/ld/ldfile.c
+++ b/ld/ldfile.c
@@ -556,18 +556,25 @@ ldfile_open_file_search (const char *arch,
      directory first.  */
   if (!entry->flags.maybe_archive)
     {
-      if (entry->flags.sysrooted && IS_ABSOLUTE_PATH (entry->filename))
+      /* For absolute pathnames, try to always open the file in the
+	 sysroot first. If this fails, try to open the file at the
+	 given location.  */
+      entry->flags.sysrooted = is_sysrooted_pathname (entry->filename);
+      if (!entry->flags.sysrooted && IS_ABSOLUTE_PATH (entry->filename)
+	  && ld_sysroot)
 	{
 	  char *name = concat (ld_sysroot, entry->filename,
 			       (const char *) NULL);
 	  if (ldfile_try_open_bfd (name, entry))
 	    {
 	      entry->filename = name;
+	      entry->flags.sysrooted = true;
 	      return true;
 	    }
 	  free (name);
 	}
-      else if (ldfile_try_open_bfd (entry->filename, entry))
+
+      if (ldfile_try_open_bfd (entry->filename, entry))
 	return true;

       if (IS_ABSOLUTE_PATH (entry->filename))
--
2.50.1

